<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krishi Sakhi | AI Farming Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .dashboard-grid {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        .page, .signup-phase {
            display: none;
        }
        .page.active, .signup-phase.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        .nav-link.active {
            background-color: #059669; /* emerald-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        .toast {
            transition: opacity 0.5s, transform 0.5s;
        }
        .card-hover {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .signup-bg {
             background-color: #f0fdf4; /* emerald-50 */
             background-image: radial-gradient(#a7f3d0 0.5px, transparent 0.5px);
             background-size: 16px 16px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* --- AI Chat Popup Styles --- */
        #chat-popup {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: 50%;
            background-color: #010201;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.5s ease-in-out, width 0.5s ease-in-out;
            box-shadow: -10px 0 30px rgba(0,0,0,0.3);
        }
        #chat-popup.active {
            transform: translateX(0);
        }
        #chat-popup.expanded {
            width: 60%; /* 3/5 of the screen */
        }

        @media (max-width: 1024px) {
            #chat-popup { width: 60%; }
            #chat-popup.expanded { width: 75%; }
        }
        @media (max-width: 768px) {
            #chat-popup { width: 100%; }
            #chat-popup.expanded { width: 100%; }
        }

        #chat-popup-header {
            padding: 1rem 1.5rem;
            background-color: #111827;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        #chat-popup-header h3 {
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
        }
        #chat-popup-controls button {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s;
        }
        #chat-popup-controls button:hover {
            color: white;
        }

        #chat-popup-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #chat-popup-history::-webkit-scrollbar { width: 8px; }
        #chat-popup-history::-webkit-scrollbar-track { background: #111827; }
        #chat-popup-history::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }

        .ai-bubble, .user-bubble {
            padding: 0.75rem 1.25rem;
            border-radius: 20px;
            max-width: 75%;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .ai-bubble {
            background-color: #374151;
            color: #e5e7eb;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .user-bubble {
            background: linear-gradient(to right, #6e1b60, #402fb5);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        #ai-chat-container {
            position: relative;
            z-index: 1;
            padding: 1rem 0;
            flex-shrink: 0;
        }

        #ai-chat-container .white,
        #ai-chat-container .border,
        #ai-chat-container .darkBorderBg,
        #ai-chat-container .glow {
            max-height: 70px;
            max-width: 314px;
            height: 100%;
            width: 100%;
            position: absolute;
            overflow: hidden;
            z-index: -1;
            border-radius: 12px;
            filter: blur(3px);
        }
        #ai-chat-container .input {
            background-color: #010201;
            border: none;
            width: 301px;
            height: 56px;
            border-radius: 10px;
            color: white;
            padding-inline: 59px;
            font-size: 18px;
        }

        #ai-chat-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #ai-chat-container .input::placeholder { color: #c0b9c0; }
        #ai-chat-container .input:focus { outline: none; }
        #ai-chat-container #main:focus-within > #input-mask { display: none; }

        #ai-chat-container #input-mask {
            pointer-events: none;
            width: 100px;
            height: 20px;
            position: absolute;
            background: linear-gradient(90deg, transparent, black);
            top: 18px;
            left: 70px;
        }
        #ai-chat-container #pink-mask {
            pointer-events: none;
            width: 30px;
            height: 20px;
            position: absolute;
            background: #cf30aa;
            top: 10px;
            left: 5px;
            filter: blur(20px);
            opacity: 0.8;
            transition: all 2s;
        }
        #ai-chat-container #main:hover > #pink-mask { opacity: 0; }
        #ai-chat-container .white { max-height: 63px; max-width: 307px; border-radius: 10px; filter: blur(2px); }

        #ai-chat-container .white::before {
            content: ""; z-index: -2; text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(83deg); position: absolute; width: 600px; height: 600px; background-repeat: no-repeat; background-position: 0 0; filter: brightness(1.4);
            background-image: conic-gradient( rgba(0, 0, 0, 0) 0%, #a099d8, rgba(0, 0, 0, 0) 8%, rgba(0, 0, 0, 0) 50%, #dfa2da, rgba(0, 0, 0, 0) 58% );
            transition: all 2s;
        }
        #ai-chat-container .border { max-height: 59px; max-width: 303px; border-radius: 11px; filter: blur(0.5px); }
        #ai-chat-container .border::before {
            content: ""; z-index: -2; text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(70deg); position: absolute; width: 600px; height: 600px; filter: brightness(1.3); background-repeat: no-repeat; background-position: 0 0;
            background-image: conic-gradient( #1c191c, #402fb5 5%, #1c191c 14%, #1c191c 50%, #cf30aa 60%, #1c191c 64% );
            transition: all 2s;
        }
        #ai-chat-container .darkBorderBg { max-height: 65px; max-width: 312px; }
        #ai-chat-container .darkBorderBg::before {
            content: ""; z-index: -2; text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(82deg); position: absolute; width: 600px; height: 600px; background-repeat: no-repeat; background-position: 0 0;
            background-image: conic-gradient( rgba(0, 0, 0, 0), #18116a, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, 0) 50%, #6e1b60, rgba(0, 0, 0, 0) 60% );
            transition: all 2s;
        }
        #ai-chat-container:hover > .darkBorderBg::before, #ai-chat-container:focus-within > .darkBorderBg::before { transform: translate(-50%, -50%) rotate(262deg); }
        #ai-chat-container:hover > .glow::before, #ai-chat-container:focus-within > .glow::before { transform: translate(-50%, -50%) rotate(240deg); }
        #ai-chat-container:hover > .white::before, #ai-chat-container:focus-within > .white::before { transform: translate(-50%, -50%) rotate(263deg); }
        #ai-chat-container:hover > .border::before, #ai-chat-container:focus-within > .border::before { transform: translate(-50%, -50%) rotate(250deg); }

        #ai-chat-container .glow { overflow: hidden; filter: blur(30px); opacity: 0.4; max-height: 130px; max-width: 354px; }
        #ai-chat-container .glow:before {
            content: ""; z-index: -2; text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(60deg); position: absolute; width: 999px; height: 999px; background-repeat: no-repeat; background-position: 0 0;
            background-image: conic-gradient( #000, #402fb5 5%, #000 38%, #000 50%, #cf30aa 60%, #000 87% );
            transition: all 2s;
        }

        #ai-chat-container #filter-icon {
            position: absolute; top: 8px; right: 8px; display: flex; align-items: center; justify-content: center; z-index: 2; max-height: 40px; max-width: 38px; height: 100%; width: 100%; isolation: isolate; overflow: hidden; border-radius: 10px; background: linear-gradient(180deg, #161329, black, #1d1b4b); border: 1px solid transparent;
        }
        #ai-chat-container .filterBorder {
            height: 42px; width: 40px; position: absolute; overflow: hidden; top: 7px; right: 7px; border-radius: 10px;
        }

        #ai-chat-container .filterBorder::before {
            content: ""; text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(90deg); position: absolute; width: 600px; height: 600px; background-repeat: no-repeat; background-position: 0 0; filter: brightness(1.35);
            background-image: conic-gradient( rgba(0, 0, 0, 0), #3d3a4f, rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 0) 50%, #3d3a4f, rgba(0, 0, 0, 0) 100% );
            animation: rotate 4s linear infinite;
        }
        @keyframes rotate { 100% { transform: translate(-50%, -50%) rotate(450deg); } }

        #ai-chat-container #main { position: relative; }
        #ai-chat-container #search-icon { position: absolute; left: 20px; top: 15px; cursor: pointer; }
        
        .video-facade {
            position: relative;
            cursor: pointer;
            border-radius: 0.5rem;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            aspect-ratio: 16 / 9;
        }
        .video-facade::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: background-color 0.2s;
        }
        .video-facade:hover::before {
            background-color: rgba(0,0,0,0);
        }
        .video-facade::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 68px;
            height: 48px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 68 48"><path d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z" fill="rgba(255,0,0,0.9)"></path><path d="M 27,19 43,24 27,29" fill="%23fff"></path></svg>');
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.2s;
        }
        .video-facade:hover::after {
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.25rem;
        }
        .typing-indicator span {
            height: 10px;
            width: 10px;
            margin: 0 2px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

    </style>
</head>
<body class="bg-slate-100">

    <div id="signup-flow" class="fixed inset-0 z-50 flex items-center justify-center p-4 signup-bg">
        <div class="w-full max-w-lg">
            <div id="signup-phase-1" class="signup-phase active bg-white p-8 rounded-2xl shadow-2xl">
                <h2 class="text-3xl font-bold text-center text-slate-800">Create your Account</h2>
                <p class="text-center text-slate-500 mt-2 mb-8">Let's get started with some basic details.</p>
                <div class="space-y-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-slate-700">Email ID</label>
                        <input type="email" id="email" class="mt-1 block w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="you@example.com">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-slate-700">Phone Number</label>
                        <input type="tel" id="phone" class="mt-1 block w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="+91 98765 43210">
                    </div>
                </div>
                <button id="next-phase-1" class="w-full bg-emerald-600 text-white font-bold text-lg py-3 px-6 rounded-lg hover:bg-emerald-700 transition-all duration-300 mt-8 shadow-lg hover:shadow-xl transform hover:-translate-y-1">Next</button>
                <div class="relative flex py-5 items-center">
                    <div class="flex-grow border-t border-slate-300"></div>
                    <span class="flex-shrink mx-4 text-slate-500">OR</span>
                    <div class="flex-grow border-t border-slate-300"></div>
                </div>
                <button id="guest-login-btn" class="w-full bg-slate-500 text-white font-bold text-lg py-3 px-6 rounded-lg hover:bg-slate-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">Use as Guest</button>
            </div>

            <div id="signup-phase-2" class="signup-phase bg-white p-8 rounded-2xl shadow-2xl">
                    <h2 class="text-3xl font-bold text-center text-slate-800">Tell us about your Farm</h2>
                    <p class="text-center text-slate-500 mt-2 mb-8">This helps us personalize your experience.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="location" class="block text-sm font-medium text-slate-700">Location of Land</label>
                            <input type="text" id="location" class="mt-1 block w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm" placeholder="e.g., Thrissur, Kerala">
                        </div>
                        <div class="flex items-end gap-2">
                            <div class="flex-grow">
                                 <label for="area" class="block text-sm font-medium text-slate-700">Area</label>
                                 <input type="number" id="area" class="mt-1 block w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm" placeholder="e.g., 5">
                            </div>
                            <div>
                                <select id="area-unit" class="h-[50px] mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm bg-white">
                                    <option>Acre</option>
                                    <option>Hectare</option>
                                    <option>Cent</option>
                                    <option>Square Feet</option>
                                    <option>Square Meter</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="soil-type" class="block text-sm font-medium text-slate-700">Type of Soil</label>
                            <select id="soil-type" class="mt-1 block w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                                <option>Laterite Soil</option>
                                <option>Alluvial Soil</option>
                                <option>Red Soil</option>
                                <option>Black Soil</option>
                                <option>Forest Loam</option>
                            </select>
                        </div>
                        <div>
                            <label for="main-crop" class="block text-sm font-medium text-slate-700">Main Crops (select one)</label>
                             <select id="main-crop" class="mt-1 block w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                                <option>Coconut</option>
                                <option>Rubber</option>
                                <option>Paddy (Rice)</option>
                                <option>Pepper</option>
                                <option>Cardamom</option>
                                <option>Tea</option>
                                <option>Banana</option>
                             </select>
                        </div>
                         <div>
                            <label for="irrigation" class="block text-sm font-medium text-slate-700">Irrigation System</label>
                             <select id="irrigation" class="mt-1 block w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm bg-white">
                                <option>Rainwater Harvesting</option>
                                <option>Borewell / Tube Well</option>
                                <option>Canal</option>
                                <option>River Lift</option>
                                <option>Drip Irrigation</option>
                             </select>
                        </div>
                    </div>
                    <div class="mt-8 flex gap-4">
                        <button id="prev-phase-2" class="w-full bg-slate-200 text-slate-700 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 transition-all">Previous</button>
                        <button id="next-phase-2" class="w-full bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">Next</button>
                    </div>
            </div>

            <div id="signup-phase-3" class="signup-phase bg-white p-8 rounded-2xl shadow-2xl">
                    <h2 class="text-3xl font-bold text-center text-slate-800">One Last Step</h2>
                    <p class="text-center text-slate-500 mt-2 mb-8">How would you describe your farming experience?</p>
                    <div class="space-y-4">
                        <label class="flex items-center p-4 border-2 border-slate-200 rounded-lg has-[:checked]:bg-emerald-50 has-[:checked]:border-emerald-500 transition-all cursor-pointer">
                            <input type="radio" name="experience" class="h-4 w-4 text-emerald-600 border-slate-300 focus:ring-emerald-500">
                            <span class="ml-4 font-medium text-slate-700">New Farmer (Beginner)</span>
                        </label>
                         <label class="flex items-center p-4 border-2 border-slate-200 rounded-lg has-[:checked]:bg-emerald-50 has-[:checked]:border-emerald-500 transition-all cursor-pointer">
                            <input type="radio" name="experience" class="h-4 w-4 text-emerald-600 border-slate-300 focus:ring-emerald-500" checked>
                            <span class="ml-4 font-medium text-slate-700">Experienced (Moderate Knowledge)</span>
                        </label>
                         <label class="flex items-center p-4 border-2 border-slate-200 rounded-lg has-[:checked]:bg-emerald-50 has-[:checked]:border-emerald-500 transition-all cursor-pointer">
                            <input type="radio" name="experience" class="h-4 w-4 text-emerald-600 border-slate-300 focus:ring-emerald-500">
                            <span class="ml-4 font-medium text-slate-700">Expert (Know Everything)</span>
                        </label>
                    </div>
                    <div class="mt-8 flex gap-4">
                        <button id="prev-phase-3" class="w-full bg-slate-200 text-slate-700 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 transition-all">Previous</button>
                        <button id="complete-signup" class="w-full bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">Complete Sign Up</button>
                    </div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden md:flex">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
        
        <aside id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen bg-white shadow-lg flex-col flex transition-transform duration-300 -translate-x-full md:translate-x-0 md:relative md:w-20 lg:w-64">
            <div>
                <div class="p-4 lg:p-6 text-center">
                    <h1 class="text-3xl font-extrabold text-emerald-700">K<span class="md:hidden lg:inline">rishi</span> S<span class="md:hidden lg:inline">akhi</span></h1>
                </div>
                <nav class="mt-6">
                    <a href="#dashboard" class="nav-link flex items-center justify-center lg:justify-start px-4 lg:px-6 py-4 text-slate-600 hover:bg-emerald-500 hover:text-white rounded-lg mx-2 my-1 transition-all duration-200">
                        <i class="ph-bold ph-layout text-3xl"></i><span class="ml-4 font-semibold md:hidden lg:inline">Dashboard</span>
                    </a>
                    <a href="#financials" class="nav-link flex items-center justify-center lg:justify-start px-4 lg:px-6 py-4 text-slate-600 hover:bg-emerald-500 hover:text-white rounded-lg mx-2 my-1 transition-all duration-200">
                        <i class="ph-bold ph-chart-bar text-3xl"></i><span class="ml-4 font-semibold md:hidden lg:inline">Financials</span>
                    </a>
                    <a href="#pest-detection" class="nav-link flex items-center justify-center lg:justify-start px-4 lg:px-6 py-4 text-slate-600 hover:bg-emerald-500 hover:text-white rounded-lg mx-2 my-1 transition-all duration-200">
                        <i class="ph-bold ph-bug text-3xl"></i><span class="ml-4 font-semibold md:hidden lg:inline">Pest Detection</span>
                    </a>
                    <a href="#marketplace" class="nav-link flex items-center justify-center lg:justify-start px-4 lg:px-6 py-4 text-slate-600 hover:bg-emerald-500 hover:text-white rounded-lg mx-2 my-1 transition-all duration-200">
                        <i class="ph-bold ph-storefront text-3xl"></i><span class="ml-4 font-semibold md:hidden lg:inline">Marketplace</span>
                    </a>
                    <a href="#knowledge-hub" class="nav-link flex items-center justify-center lg:justify-start px-4 lg:px-6 py-4 text-slate-600 hover:bg-emerald-500 hover:text-white rounded-lg mx-2 my-1 transition-all duration-200">
                        <i class="ph-bold ph-books text-3xl"></i><span class="ml-4 font-semibold md:hidden lg:inline">Knowledge Hub</span>
                    </a>
                    <a href="#schemes" class="nav-link flex items-center justify-center lg:justify-start px-4 lg:px-6 py-4 text-slate-600 hover:bg-emerald-500 hover:text-white rounded-lg mx-2 my-1 transition-all duration-200">
                        <i class="ph-bold ph-scroll text-3xl"></i><span class="ml-4 font-semibold md:hidden lg:inline">Schemes</span>
                    </a>
                    <a href="#community" class="nav-link flex items-center justify-center lg:justify-start px-4 lg:px-6 py-4 text-slate-600 hover:bg-emerald-500 hover:text-white rounded-lg mx-2 my-1 transition-all duration-200">
                        <i class="ph-bold ph-users-three text-3xl"></i><span class="ml-4 font-semibold md:hidden lg:inline">Community</span>
                    </a>
                    <a href="#future-advancement" class="nav-link flex items-center justify-center lg:justify-start px-4 lg:px-6 py-4 text-slate-600 hover:bg-emerald-500 hover:text-white rounded-lg mx-2 my-1 transition-all duration-200">
                        <i class="ph-bold ph-rocket-launch text-3xl"></i><span class="ml-4 font-semibold md:hidden lg:inline">Future Features</span>
                    </a>
                </nav>
            </div>
            <div class="p-4 lg:p-6 mt-auto border-t border-slate-200">
                <a href="#" id="logout-btn" class="flex items-center justify-center lg:justify-start w-full py-3 text-slate-600 hover:bg-red-50 hover:text-red-600 rounded-lg transition-colors">
                    <i class="ph-bold ph-sign-out text-3xl"></i>
                    <span class="ml-4 font-semibold md:hidden lg:inline">Logout</span>
                </a>
                <p class="text-xs text-slate-400 text-center mt-4 md:hidden lg:block">SIH 2025 Demo</p>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto">
            <header class="md:hidden bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-20">
                <h1 class="text-2xl font-extrabold text-emerald-700">Krishi Sakhi</h1>
                <button id="hamburger-btn" class="text-3xl text-slate-700">
                    <i class="ph-bold ph-list"></i>
                </button>
            </header>
            <div class="p-4 md:p-8">

                <div id="dashboard" class="page active">
                    <h2 id="dashboard-greeting" class="text-4xl font-extrabold text-slate-800 mb-6">Welcome back, Farmer!</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 dashboard-grid">
                        
                        <div id="weather-card" class="bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-6 rounded-2xl shadow-lg col-span-1 md:col-span-2 card-hover">
                            </div>

                        <div class="bg-white p-6 rounded-2xl shadow-lg card-hover">
                            <h3 class="font-bold text-slate-800 text-lg mb-4">Farm Condition</h3>
                            <div class="space-y-4" id="farm-conditions-container">
                                </div>
                        </div>

                        <div id="yield-prediction-card" class="bg-white p-6 rounded-2xl shadow-lg card-hover">
                                </div>

                        <div class="bg-white p-6 rounded-2xl shadow-lg card-hover">
                            <h3 class="font-bold text-slate-800 text-lg mb-4">Market Prices (Local Mandi)</h3>
                            <ul id="market-prices-list" class="space-y-3">
                                </ul>
                        </div>
                        
                        <div class="bg-white p-6 rounded-2xl shadow-lg col-span-1 md:col-span-2 card-hover">
                            <h3 class="font-bold text-slate-800 text-lg mb-4">AI Suggestions of the Day</h3>
                            <ul id="ai-suggestions-list" class="space-y-3">
                                </ul>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-lg col-span-1 md:col-span-2 card-hover">
                            <h3 class="font-bold text-slate-800 text-lg mb-4">Upcoming Tasks</h3>
                            <ul id="upcoming-tasks-list" class="space-y-3">
                                </ul>
                        </div>

                    </div>
                </div>

                <div id="financials" class="page">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-4xl font-extrabold text-slate-800">Financials Dashboard</h2>
                        <button id="log-transaction-btn" class="bg-emerald-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-emerald-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center">
                            <i class="ph-bold ph-plus-circle mr-2"></i>Log Transaction
                        </button>
                    </div>
                    <div id="financials-summary-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="font-bold text-slate-800 text-lg mb-4">Income vs Expenses (Last 6 Months)</h3>
                            <div class="chart-container">
                                <canvas id="financialsChart"></canvas>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h3 class="font-bold text-slate-800 text-lg mb-4">Expense Breakdown</h3>
                                <div class="chart-container h-[250px] max-h-[250px]">
                                    <canvas id="expenseBreakdownChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                    <h3 class="font-bold text-slate-800 text-lg mb-4">Recent Transactions</h3>
                                    <ul id="transactions-list" class="space-y-4 max-h-64 overflow-y-auto pr-2">
                                        </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pest-detection" class="page">
                    <h2 class="text-4xl font-extrabold text-slate-800 mb-6">Pest & Disease Detection</h2>
                    <div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                        
                        <div id="upload-section">
                            <h3 class="text-xl font-bold text-center text-slate-800">Upload Crop Photo</h3>
                            <div class="mt-4 border-2 border-dashed border-slate-300 rounded-lg p-10 text-center bg-slate-50 cursor-pointer" id="drop-zone">
                                <input type="file" id="crop-photo-input" class="hidden" accept="image/*">
                                <i class="ph-bold ph-upload-simple text-5xl text-emerald-500"></i>
                                <p class="mt-2 text-slate-600">Click to upload or drag and drop</p>
                                <p class="text-xs text-slate-400 mt-1">Supports JPG, PNG files</p>
                            </div>
                        </div>

                        <div id="preview-section" class="hidden">
                                <img id="image-preview" src="#" alt="Crop Preview" class="max-h-64 w-auto mx-auto rounded-lg shadow-md"/>
                                <button id="analyze-button" class="mt-4 w-full bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-emerald-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-1">
                                    <i class="ph-bold ph-magnifying-glass mr-2"></i>Analyze Image
                                </button>
                        </div>
                        
                        <div id="analysis-report" class="mt-6 hidden">
                            <div id="loading-spinner" class="text-center py-4">
                                <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-600"></div>
                                <p class="text-slate-600 mt-2">Analyzing image...</p>
                            </div>
                            <div id="report-content" class="hidden">
                                <h3 class="text-2xl font-bold text-slate-800 mb-4 text-center">AI Analysis Report</h3>
                                <div class="space-y-4">
                                    <div class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-r-lg">
                                        <div class="flex items-center">
                                            <i class="ph-bold ph-warning-circle text-2xl mr-3"></i>
                                            <div>
                                                <p class="font-bold">Disease Detected</p>
                                                <p id="disease-name"></p>
                                                <p id="disease-confidence" class="text-sm"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-slate-50 p-4 rounded-lg">
                                        <h4 class="font-bold text-slate-800">Recommended Action</h4>
                                        <p id="recommended-action" class="text-slate-600 mt-1"></p>
                                    </div>
                                     <div class="bg-slate-50 p-4 rounded-lg">
                                        <h4 class="font-bold text-slate-800">Preventative Measures</h4>
                                        <p id="preventative-measures" class="text-slate-600 mt-1"></p>
                                    </div>
                                     <div class="bg-slate-50 p-4 rounded-lg">
                                        <h4 class="font-bold text-slate-800">Organic Alternatives</h4>
                                        <p id="organic-alternatives" class="text-slate-600 mt-1"></p>
                                    </div>
                                </div>
                                <button id="download-report-btn" class="mt-6 w-full bg-slate-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-slate-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-1">
                                    <i class="ph-bold ph-download-simple mr-2"></i>Download Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="marketplace" class="page">
                    <h2 class="text-4xl font-extrabold text-slate-800 mb-6">Marketplace - Connect with Buyers</h2>
                    <div id="buyers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>
                
                <div id="knowledge-hub" class="page">
                    <h2 class="text-4xl font-extrabold text-slate-800 mb-6">Knowledge Hub</h2>
                    <div id="articles-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>

                <div id="schemes" class="page">
                    <h2 class="text-4xl font-extrabold text-slate-800 mb-6">Government Schemes & Subsidies</h2>
                    <div id="schemes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>

                <div id="community" class="page">
                    <h2 class="text-4xl font-extrabold text-slate-800 mb-6">Community Forum</h2>
                    <div class="max-w-3xl mx-auto">
                        <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                            <textarea class="w-full border-slate-300 rounded-lg p-3 focus:ring-emerald-500 focus:border-emerald-500" rows="3" placeholder="Ask a question or share an update..."></textarea>
                            <button class="mt-4 w-full bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition-colors">Post to Community</button>
                        </div>
                        <div id="forum-posts" class="space-y-4">
                            </div>
                    </div>
                </div>

                <div id="future-advancement" class="page">
                    <h2 class="text-4xl font-extrabold text-slate-800 mb-6">Future Advancements</h2>
                    <p class="text-lg text-slate-600 mb-8 max-w-3xl">Here's a roadmap of exciting features we're planning to introduce to make Krishi Sakhi even more powerful for the farming community.</p>
                    <div id="future-features-list" class="space-y-6">
                        </div>
                </div>

            </div>
        </main>
    </div>
    
    <div id="chat-popup">
        <div id="chat-popup-header">
            <h3>AI Assistant</h3>
            <div id="chat-popup-controls" class="flex items-center gap-2">
                <button id="expand-chat-btn" title="Expand/Collapse">
                    <i class="ph-bold ph-arrows-out-line-horizontal text-xl"></i>
                </button>
                <button id="close-chat-btn" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
        </div>
        <div id="chat-popup-history">
             <div class="ai-bubble">
                <p>Hello! I am your AI Farming Assistant. Ask me anything about your crops, weather, or market prices.</p>
            </div>
        </div>
        <div id="ai-chat-container">
            <div class="glow"></div>
            <div class="darkBorderBg"></div>
            <div class="darkBorderBg"></div>
            <div class="darkBorderBg"></div>
            <div class="white"></div>
            <div class="border"></div>
            <div id="main">
                <input placeholder="Ask me anything..." type="text" name="text" class="input" id="ai-chat-input"/>
                <div id="input-mask"></div>
                <div id="pink-mask"></div>
                <div class="filterBorder"></div>
                <div id="filter-icon">
                    <svg preserveAspectRatio="none" height="27" width="27" viewBox="4.8 4.56 14.832 15.408" fill="none" >
                        <path d="M8.16 6.65002H15.83C16.47 6.65002 16.99 7.17002 16.99 7.81002V9.09002C16.99 9.56002 16.7 10.14 16.41 10.43L13.91 12.64C13.56 12.93 13.33 13.51 13.33 13.98V16.48C13.33 16.83 13.1 17.29 12.81 17.47L12 17.98C11.24 18.45 10.2 17.92 10.2 16.99V13.91C10.2 13.5 9.97 12.98 9.73 12.69L7.52 10.36C7.23 10.08 7 9.55002 7 9.20002V7.87002C7 7.17002 7.52 6.65002 8.16 6.65002Z" stroke="#d6d6e6" stroke-width="1" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round" ></path>
                    </svg>
                </div>
                <div id="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" height="24" fill="none" class="feather feather-search">
                        <circle stroke="url(#search)" r="8" cy="11" cx="11"></circle>
                        <line stroke="url(#searchl)" y2="16.65" y1="22" x2="16.65" x1="22"></line>
                        <defs>
                            <linearGradient gradientTransform="rotate(50)" id="search">
                            <stop stop-color="#f8e7f8" offset="0%"></stop>
                            <stop stop-color="#b6a9b7" offset="50%"></stop>
                            </linearGradient>
                            <linearGradient id="searchl">
                            <stop stop-color="#b6a9b7" offset="0%"></stop>
                            <stop stop-color="#837484" offset="50%"></stop>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <div id="fab-container" class="fixed bottom-6 right-6 z-50 hidden">
        <div class="relative flex flex-col items-center space-y-4">
            <div id="quick-actions-menu" class="flex flex-col items-end space-y-2 mb-2 hidden">
                <button class="quick-action-item bg-white text-slate-700 w-52 text-left p-3 rounded-lg shadow-xl flex items-center hover:bg-slate-100 transition-all" data-action="log">
                    <i class="ph-bold ph-clipboard-text text-xl text-emerald-600"></i>
                    <span class="ml-3 font-semibold">Log Activity</span>
                </button>
                <button class="quick-action-item bg-white text-slate-700 w-52 text-left p-3 rounded-lg shadow-xl flex items-center hover:bg-slate-100 transition-all" data-action="upload">
                    <i class="ph-bold ph-camera text-xl text-emerald-600"></i>
                    <span class="ml-3 font-semibold">Upload Photo</span>
                </button>
                <button class="quick-action-item bg-white text-slate-700 w-52 text-left p-3 rounded-lg shadow-xl flex items-center hover:bg-slate-100 transition-all" data-action="community">
                    <i class="ph-bold ph-chats-circle text-xl text-emerald-600"></i>
                    <span class="ml-3 font-semibold">Ask Community</span>
                </button>
            </div>
            
            <button id="chat-toggle-btn" class="bg-amber-500 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-4xl hover:bg-amber-600 transition-transform hover:scale-110">
                <i class="ph-fill ph-chat-circle-dots"></i>
            </button>
    
            <button id="quick-actions-toggle" class="bg-emerald-600 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-4xl hover:bg-emerald-700 transition-all hover:scale-110">
                <i class="ph-bold ph-plus"></i>
            </button>
        </div>
    </div>
    
    <div id="log-activity-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-[120]">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
            <h3 class="text-2xl font-bold text-slate-800 mb-4">Log Farm Activity</h3>
            <p class="text-slate-600 mb-6">Keep your records updated for better AI advice.</p>
            <textarea id="activity-log-input" class="w-full border-slate-300 rounded-lg p-3 focus:ring-emerald-500 focus:border-emerald-500" rows="4" placeholder="e.g., Irrigated 2 acres of paddy field."></textarea>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel" class="bg-slate-200 text-slate-700 font-semibold py-2 px-5 rounded-lg hover:bg-slate-300">Cancel</button>
                <button id="modal-save" class="bg-emerald-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-emerald-700">Save Log</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed top-5 right-5 bg-emerald-600 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transform -translate-y-12 toast z-[200]">
        <p id="toast-message" class="font-semibold"></p>
    </div>

    <div id="scheme-details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[140]">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center">
                    <h3 id="modal-scheme-title" class="text-3xl font-bold text-slate-800"></h3>
                    <button id="modal-scheme-close" class="text-slate-500 hover:text-slate-800 text-2xl">
                        <i class="ph-bold ph-x-circle"></i>
                    </button>
            </div>
            
            <div class="mt-6">
                <h4 class="font-semibold text-lg text-slate-700">Scheme Details</h4>
                <p id="modal-scheme-description" class="text-slate-600 mt-2"></p>
            </div>

            <div class="mt-6">
                <h4 class="font-semibold text-lg text-slate-700">Required Documents</h4>
                <ul id="modal-scheme-documents" class="list-disc list-inside mt-2 space-y-2 text-slate-600">
                </ul>
            </div>

            <div id="modal-youtube-container" class="mt-6">
                    <h4 class="font-semibold text-lg text-slate-700 mb-2">Helpful Video</h4>
                    <iframe id="modal-youtube-video" class="w-full aspect-video rounded-lg" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <div class="mt-8">
                <a id="modal-scheme-apply-link" href="#" target="_blank" rel="noopener noreferrer" class="block w-full text-center bg-emerald-600 text-white font-bold text-lg py-3 px-6 rounded-lg hover:bg-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    Apply Now <i class="ph-bold ph-arrow-square-out ml-2"></i>
                </a>
            </div>
        </div>
    </div>

    <div id="log-transaction-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[130]">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-slate-800">Log a Transaction</h3>
                <button id="close-transaction-modal" class="text-slate-500 hover:text-slate-800 text-2xl"><i class="ph-bold ph-x-circle"></i></button>
            </div>
            <form id="transaction-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700">Transaction Type</label>
                    <div class="mt-1 grid grid-cols-2 gap-2 rounded-lg bg-slate-200 p-1">
                        <label class="text-center py-2 rounded-md cursor-pointer has-[:checked]:bg-white has-[:checked]:shadow font-semibold text-slate-700">
                            <input type="radio" name="transaction-type" value="income" class="sr-only" checked> Income
                        </label>
                         <label class="text-center py-2 rounded-md cursor-pointer has-[:checked]:bg-white has-[:checked]:shadow font-semibold text-slate-700">
                            <input type="radio" name="transaction-type" value="expense" class="sr-only"> Expense
                        </label>
                    </div>
                </div>
                 <div>
                    <label for="transaction-description" class="block text-sm font-medium text-slate-700">Description</label>
                    <input type="text" id="transaction-description" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" required>
                </div>
                 <div>
                    <label for="transaction-amount" class="block text-sm font-medium text-slate-700">Amount (₹)</label>
                    <input type="number" id="transaction-amount" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div id="category-wrapper">
                     <label for="transaction-category" class="block text-sm font-medium text-slate-700">Category</label>
                     <select id="transaction-category" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white">
                        <option>Fertilizers</option>
                        <option>Seeds</option>
                        <option>Labor</option>
                        <option>Equipment</option>
                        <option>Other</option>
                     </select>
                </div>
                 <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-emerald-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-emerald-700">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <div id="knowledge-details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[145]">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                    <h3 id="modal-knowledge-title" class="text-3xl font-bold text-slate-800"></h3>
                    <button id="modal-knowledge-close" class="text-slate-500 hover:text-slate-800 text-2xl">
                        <i class="ph-bold ph-x-circle"></i>
                    </button>
            </div>
            
            <div id="modal-knowledge-content" class="text-slate-600 mt-4 prose prose-emerald max-w-none">
                </div>

            <div id="modal-knowledge-youtube-container" class="mt-6 space-y-4">
                    <h4 class="font-semibold text-lg text-slate-700 mb-2">Helpful Videos</h4>
                    </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentUser = 'Farmer';
        
        // --- SIGNUP FLOW ---
        const signupFlow = document.getElementById('signup-flow');
        const mainApp = document.getElementById('main-app');
        const signupPhases = document.querySelectorAll('.signup-phase');
        const emailInput = document.getElementById('email');

        let currentPhase = 1;

        function showPhase(phaseNumber) {
            signupPhases.forEach(p => p.classList.remove('active'));
            const activePhase = document.getElementById(`signup-phase-${phaseNumber}`);
            if(activePhase) activePhase.classList.add('active');
        }

        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-3rem)';
            }, duration);
        }

        function updateDashboardGreeting() {
            const greetingElement = document.getElementById('dashboard-greeting');
            if (greetingElement) {
                greetingElement.textContent = `Welcome back, ${currentUser}!`;
            }
        }
        
        function transitionToApp() {
            signupFlow.classList.add('hidden');
            mainApp.classList.remove('hidden');
            mainApp.style.animation = 'fadeIn 0.5s ease-in-out';
            document.getElementById('fab-container').classList.remove('hidden'); // Show FABs
            updateDashboardGreeting();
        }

        document.getElementById('next-phase-1').addEventListener('click', () => {
            showToast('Authentication complete!');
            setTimeout(() => {
                currentPhase = 2;
                showPhase(currentPhase);
            }, 500);
        });

        document.getElementById('next-phase-2').addEventListener('click', () => {
            currentPhase = 3;
            showPhase(currentPhase);
        });

        document.getElementById('prev-phase-2').addEventListener('click', () => {
            currentPhase = 1;
            showPhase(currentPhase);
        });

        document.getElementById('prev-phase-3').addEventListener('click', () => {
            currentPhase = 2;
            showPhase(currentPhase);
        });

        document.getElementById('complete-signup').addEventListener('click', () => {
            const userEmail = emailInput.value.trim();
            if (userEmail && userEmail.includes('@')) {
                currentUser = userEmail.split('@')[0];
            } else {
                currentUser = 'User';
            }
            showToast('Authentication complete. Preparing your dashboard...', 2000);
            setTimeout(transitionToApp, 2000);
        });
        
        const guestLoginBtn = document.getElementById('guest-login-btn');
        guestLoginBtn.addEventListener('click', () => {
            currentUser = 'Guest';
            showToast('Entering as guest...', 1500);
            setTimeout(transitionToApp, 1500);
        });


        // --- MOCK DATA ---
        const MOCK_DATA = {
            weather: {
                current: { temp: 29, humidity: 85, condition: 'Partly Cloudy', icon: 'ph-fill ph-cloud-sun' },
                forecast: [
                    { day: 'Today', icon: 'ph-fill ph-cloud-sun', high: 29, low: 24 },
                    { day: 'Mon', icon: 'ph-fill ph-cloud-rain', high: 28, low: 23 },
                    { day: 'Tue', icon: 'ph-fill ph-cloud-lightning', high: 27, low: 23 },
                    { day: 'Wed', icon: 'ph-fill ph-wind', high: 29, low: 24 },
                    { day: 'Thu', icon: 'ph-fill ph-sun', high: 31, low: 25 },
                ]
            },
            farmConditions: [
                { name: 'Soil Moisture', value: 72, color: 'bg-sky-500' },
                { name: 'Nutrient Levels', value: 85, color: 'bg-lime-500' },
                { name: 'Overall Farm Health', value: 91, color: 'bg-emerald-500' },
            ],
            yieldPrediction: { crop: 'Coconut', predicted: '8.5 tons/acre', confidence: '88%' },
            marketPrices: [
                { name: 'Coconut', price: '₹ 3,200/q', trend: 'up' },
                { name: 'Rubber', price: '₹ 17,500/q', trend: 'down' },
                { name: 'Banana', price: '₹ 2,800/q', trend: 'up' },
                { name: 'Pepper', price: '₹ 51,000/q', trend: 'stable' },
            ],
            aiSuggestions: [
                "Light rain expected. Consider delaying irrigation for paddy crops by 1 day.",
                "Market price for coconuts is up by 5% in the local Mandi. Good day to sell.",
                "Check for signs of yellow leaf disease on your areca nut plants.",
            ],
            upcomingTasks: [
                { time: 'Today', task: 'Apply fertilizer to banana plants.' },
                { time: 'Tomorrow', task: 'Pest scouting for coconut trees.' },
                { time: 'In 3 days', task: 'Begin next irrigation cycle for paddy fields.' },
            ],
            pestDetectionReport: {
                diseaseName: 'Leaf Blight (Minor Severity)',
                confidence: 'Confidence: 85%',
                recommendedAction: 'Apply a copper-based fungicide like Bordeaux mixture (1%) on affected areas. Ensure proper air circulation around plants and avoid overhead watering.',
                preventativeMeasures: 'Maintain proper plant spacing for air circulation. Remove fallen leaves regularly. Use drip irrigation instead of sprinkler systems to keep leaves dry.',
                organicAlternatives: 'Use neem oil spray (5ml per liter) or baking soda solution (1 tsp per liter) as organic alternatives. Spray during early morning or evening.'
            },
            schemes: [
                { 
                    title: 'Pradhan Mantri Kisan Samman Nidhi', 
                    description: 'Provides income support to all landholding farmer families.', 
                    eligibility: 'All Farmers',
                    detailedDescription: 'A central government income support scheme. Provides ₹6,000 per annum to land-holding farmer families, in three instalments of ₹2,000 each. Aimed at helping farmers buy agricultural inputs and reduce dependency on informal credit.',
                    documents: ['Aadhaar card', 'Proof of citizenship (if required)', 'Documents showing ownership of cultivable land', 'Bank account details (for DBT)'],
                    applyLink: 'https://pmkisan.gov.in/',
                    youtubeLink: 'https://www.youtube.com/embed/Uq9ktF-QycY'
                },
                { 
                    title: 'Kisan Credit Card (KCC)', 
                    description: 'Offers credit to farmers for their farming and other needs.', 
                    eligibility: 'Farmers, Fishermen',
                    detailedDescription: 'A credit scheme to provide farmers with timely, low-cost credit for agricultural and allied needs (crop cultivation, post-harvest expenses etc.). Helps reduce dependence on high interest informal credit sources.',
                    documents: ['Completed KCC Application form', 'Two passport-size photographs', 'Identity proof (Aadhaar/Voter ID)', 'Address proof', 'Proof of landholding', 'Cropping pattern details'],
                    applyLink: 'https://www.sbi.co.in/web/agri-rural/agriculture-banking/crop-finance/kisan-credit-card',
                    youtubeLink: 'https://www.youtube.com/embed/70-qwhsDglI'
                },
                { 
                    title: 'National Mission for Sustainable Agriculture', 
                    description: 'Promotes sustainable agriculture practices.', 
                    eligibility: 'Varies',
                    detailedDescription: 'A mission under Ministry of Agriculture & Farmers Welfare, focused on enhancing agricultural productivity especially in rainfed areas. Key components: Integrated Farming, Water Use Efficiency, Soil Health Management, etc.',
                    documents: ['Application / project proposal document', 'Bank account details for fund transfers', 'Aadhaar / identity proof', 'Soil health card and land mapping documents'],
                    applyLink: 'https://nmsa.gov.in/default.aspx',
                    youtubeLink: 'https://www.youtube.com/embed/UmS7oH-gRZ8'
                },
                { 
                    title: 'Rashtriya Krishi Vikas Yojana (RKVY)', 
                    description: 'Aims to achieve growth in the agriculture sector.', 
                    eligibility: 'State Govt. Projects',
                    detailedDescription: 'A scheme for holistic development of agriculture & allied sectors. It encourages states to plan and implement agricultural development programmes. Under RKVY-RAFTAAR, there is more focus on innovation and enhancing returns to farmers.',
                    documents: ['Valid bank account', 'Aadhaar or other government-issued ID', 'Documents specific to the project being applied for'],
                    applyLink: 'https://rkvy.nic.in/',
                    youtubeLink: 'https://www.youtube.com/embed/qCTfIIU3t1M'
                }
            ],
            forumPosts: [
                { user: 'Ramesh K.', post: 'What is the best organic pesticide for controlling aphids on my vegetable patch?', replies: 3, likes: 8 },
                { user: 'Sita Menon', post: 'Sharing a photo of my healthy tomato harvest! Thanks to the tips from this app.', replies: 5, likes: 22 },
                { user: 'Anil Varma', post: 'Urgent help needed! My rubber trees are showing signs of leaf fall disease. What should I do?', replies: 7, likes: 15 },
            ],
            financials: {
                summary: { income: 50000, expenses: 22000, profit: 28000 },
                chartData: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    income: [12000, 19000, 3000, 5000, 2000, 9000],
                    expenses: [7000, 8000, 2000, 3000, 1500, 4500]
                },
                expenseBreakdown: {
                    labels: ['Fertilizers', 'Seeds', 'Labor', 'Equipment', 'Other'],
                    data: [8000, 5500, 4000, 3000, 1500]
                },
                transactions: [
                    { type: 'income', description: 'Sold 10 quintals of Coconut', amount: 32000, date: '2025-09-15' },
                    { type: 'expense', description: 'Purchased NPK Fertilizer', amount: 8000, date: '2025-09-12', category: 'Fertilizers' },
                    { type: 'expense', description: 'Tractor rental for ploughing', amount: 3000, date: '2025-09-10', category: 'Equipment' },
                    { type: 'income', description: 'Sold Bananas (local market)', amount: 18000, date: '2025-09-05' },
                    { type: 'expense', description: 'Hired labor for weeding', amount: 4000, date: '2025-09-02', category: 'Labor' },
                ]
            },
            futureAdvancements: [
                {
                    title: 'AI Crop Health Monitoring',
                    description: 'Utilizes Satellite NDVI data and advanced image scanning to provide a macro and micro view of your farm\'s health, detecting stress points before they become visible to the naked eye.',
                    details: [
                        'Regular satellite imagery analysis for large-scale monitoring.',
                        'Drone or phone camera integration for high-resolution scanning.',
                        'Early detection of nutrient deficiencies and water stress.'
                    ]
                },
                {
                    title: 'Digital Payments & Farmer Wallet',
                    description: 'A secure, integrated digital wallet for all farm-related transactions. Receive payments from buyers, pay for supplies, and manage subsidies directly within the app.',
                    details: [
                        'Seamless peer-to-peer and business transactions.',
                        'Easy tracking of all income and expenses.',
                        'Direct subsidy deposits from government schemes.'
                    ]
                },
                {
                    title: 'Crop Insurance & Loan Support',
                    description: 'Get recommendations for the best crop insurance policies based on your farm data and access simplified loan application processes through partner institutions.',
                    details: [
                        'Personalized insurance plan suggestions.',
                        'EMI and premium calculators.',
                        'Streamlined digital application for loans.'
                    ]
                },
                {
                    title: 'Predictive Analytics & Yield Estimation',
                    description: 'Leveraging historical data and AI models to forecast crop yields with high accuracy, helping you make better decisions for storage and market sales.',
                    details: [
                        'AI-powered yield forecasts for your specific crops.',
                        'Analysis of weather impact on future yield.',
                        'Informed planning for harvesting and sales.'
                    ]
                },
                {
                    title: 'Pest/Disease Early Warning Network',
                    description: 'A community-powered alert system. When farmers in your region report a pest, our AI analyzes the pattern and sends out early warnings to prevent widespread outbreaks.',
                    details: [
                        'Farmers in the same area share pest alerts.',
                        'AI detects outbreak patterns and sends region-wide warnings.',
                        'Proactive measures to protect your crops.'
                    ]
                },
                 {
                    title: 'Impact Dashboard & Offline Mode',
                    description: 'An advanced dashboard to track profit vs. expense, yield trends, and generate exportable reports for documentation. All essential features will be available in offline or low-data modes.',
                    details: [
                        'Visualize your farm\'s financial health over time.',
                        'Generate PDF reports for loans or records.',
                        'Access critical advisories without an active internet connection.'
                    ]
                }
            ],
            buyers: [
                { name: 'Kerala Spices Co.', location: 'Kochi', interestedIn: ['Pepper', 'Cardamom'], rating: 4.8 },
                { name: 'Fresh Produce Exporters', location: 'Trivandrum', interestedIn: ['Banana', 'Pineapple'], rating: 4.5 },
                { name: 'South Coconut Traders', location: 'Alappuzha', interestedIn: ['Coconut', 'Copra'], rating: 4.7 },
            ],
            knowledgeArticles: [
                { 
                    title: 'Advanced Irrigation Techniques for Paddy Fields', 
                    category: 'Water Management', 
                    readTime: '8 min',
                    image: 'assets/figure1.png',
                    modalTitle: 'Advanced Irrigation Techniques for Paddy Fields',
                    detailedContent: `
                        <p class="text-slate-600 mt-2">Paddy (rice) cultivation traditionally relies on continuous flooding, which leads to large water use, inefficiencies, and greenhouse gas emissions. Advanced irrigation strategies aim to optimize water use, improve yields, and reduce environmental impacts.</p>
                        <h4 class="font-semibold text-lg text-slate-700 mt-4">Key Techniques & Innovations</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-300 mt-2">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900">Technique</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900">How It Works</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900">Benefits & Challenges</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200 bg-white">
                                    <tr>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Alternate Wetting and Drying (AWD)</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Instead of keeping fields continuously flooded, allow soil to dry to a threshold, then re-flood.</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Can reduce water use by ~20–25% with minimal yield loss; also lowers methane emissions. However, timing is sensitive — too much drying stresses plants.</td>
                                    </tr>
                                    <tr>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Drip or Subsurface Drip Irrigation (SDI)</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Delivering water directly to the root zone via buried or surface drip lines.</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Very high water efficiency, reduced evaporation. But difficult to implement in flooded fields; cost and clogging are challenges.</td>
                                    </tr>
                                    <tr>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Conversion of open channels to closed conduits / piped systems</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Instead of open earthen canals, use sealed pipes or channels to reduce seepage and evaporation losses.</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">In a study, converting open channels improved irrigation efficiency by ~5.4%.</td>
                                    </tr>
                                    <tr>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Smart / sensor-driven scheduling</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Use soil moisture sensors, weather data, or AI models to decide when and how much to irrigate.</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Can optimize water use while avoiding stress or overwatering. Needs investment in sensors, automation, connectivity.</td>
                                    </tr>
                                    <tr>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Direct Seeded Rice (DSR)</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Seed rice directly rather than transplanting seedlings. This reduces the need for constant flooding in early stages.</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Saves labor and water, reduces methane emissions in early period. However, weed control becomes more challenging.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <h4 class="font-semibold text-lg text-slate-700 mt-4">Practical Tips to Apply in Paddy Fields</h4>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-slate-600">
                            <li>Use perforated PVC “observation tubes” to monitor subsurface water levels and decide when to re-flood.</li>
                            <li>Avoid letting the soil dry beyond critical thresholds (especially during vegetative or reproductive stages).</li>
                            <li>Combine infrastructural improvements (e.g. lined canals, pipelines) with scheduling and sensor-based control to maximize efficiency.</li>
                            <li>In areas of high rainfall, AWD may not be feasible because soils rarely dry enough.</li>
                            <li>Perform pilot testing in parts of your field before converting the whole area.</li>
                        </ul>
                    `,
                    youtubeLinks: [
                        'https://www.youtube.com/embed/0qu2T7JaVDw',
                        'https://www.youtube.com/embed/Br5c3ZZ_kuc',
                        'https://www.youtube.com/embed/IvlkZBiaDBg'
                    ]
                },
                { 
                    title: 'Organic Pest Control for Common Vegetables', 
                    category: 'Pest Control', 
                    readTime: '12 min',
                    image: 'assets/figure2.png',
                    modalTitle: 'Organic Pest Control for Common Vegetables',
                    detailedContent: `
                        <p class="text-slate-600 mt-2">Conventional chemical pesticides can harm beneficial insects, degrade soil health, and leave residues. Organic (or biocontrol-based) management emphasizes ecological balance and prevention.</p>
                        <h4 class="font-semibold text-lg text-slate-700 mt-4">Core Strategies</h4>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-slate-600">
                            <li><strong>Cultural & Preventive Measures:</strong> Crop rotation, intercropping, and trap crops to break pest cycles. Use pest-resistant vegetable varieties. Maintain healthy soil — plants under stress are more susceptible to pests. Sanitation: remove infested plant debris, weeds, etc.</li>
                            <li><strong>Biological Controls & Beneficial Organisms:</strong> Introduce or attract beneficial insects (ladybugs, predatory wasps, lacewings) that prey on pests. Use microbial biopesticides — Bacillus thuringiensis (Bt), beneficial fungi (Trichoderma), etc. Use nematode-suppressing amendments or biocontrol nematodes. Use organic matter (compost, vermicompost) to boost soil organisms that compete with or antagonize pests.</li>
                            <li><strong>Physical & Mechanical Methods:</strong> Insect traps (pheromone traps, sticky traps) to monitor or reduce pest populations. Row covers, nets, barriers to block pests. Manual removal (handpicking eggs, larvae). Use of trap crops (plants that attract pests away from your main crop).</li>
                            <li><strong>Botanical & Organic Pesticides (as last resort):</strong> Neem oil, kaolin clay, pyrethrin (when allowed) — use carefully to minimize negative effects on beneficials. Use lower-risk substances around sensitive stages. Always follow organic-certification rules and safe application methods.</li>
                        </ul>
                        <h4 class="font-semibold text-lg text-slate-700 mt-4">Best Practices & Tips</h4>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-slate-600">
                            <li>Regular scouting is critical: detect pests early before populations explode.</li>
                            <li>Keep good records of pest outbreaks, weather, and control measures to refine strategies over time.</li>
                            <li>Combine multiple methods (an integrated approach), rather than relying on one method alone.</li>
                            <li>Be conservative with interventions — maintain balance so beneficial organisms can thrive.</li>
                            <li>When applying botanical/pesticide sprays, do so at times least harmful to pollinators (early morning, evening).</li>
                        </ul>
                    `,
                    youtubeLinks: [
                        'https://www.youtube.com/embed/4dwOwXZ9r08',
                        'https://www.youtube.com/embed/dk1BCU1kAOA',
                        'https://www.youtube.com/embed/E2O_YOqOIZw',
                        'https://www.youtube.com/embed/7s0NzXP5Kp4'
                    ]
                },
                { 
                    title: 'Understanding Soil Health and Nutrients', 
                    category: 'Soil Health', 
                    readTime: '15 min',
                    image: 'assets/figure3.png',
                    modalTitle: 'Understanding Soil Health and Nutrients',
                    detailedContent: `
                        <p class="text-slate-600 mt-2">Soil health refers to the capacity of soil to function as a living ecosystem that sustains plants, animals, and humans. It involves the physical structure, chemical fertility, and biological activity of soil.</p>
                        <h4 class="font-semibold text-lg text-slate-700 mt-4">Key Components of Soil Health</h4>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-slate-600">
                            <li><strong>Soil organic matter (SOM):</strong> The decomposed plant/animal residue. It feeds microbes, improves structure, and holds moisture.</li>
                            <li><strong>Soil structure & porosity:</strong> Good aggregation allows air and water movement, root penetration, and reduces compaction.</li>
                            <li><strong>Biological life / microbial activity:</strong> Bacteria, fungi, earthworms, macro- and micro-organisms help cycle nutrients, suppress disease, and improve soil resilience.</li>
                            <li><strong>Chemical fertility / nutrient availability:</strong> Balanced levels of N, P, K, micronutrients (e.g. Zn, Fe, Mn) in plant-available forms.</li>
                            <li><strong>pH, salinity, cation exchange capacity (CEC):</strong> These govern how nutrients are held, released, or locked up.</li>
                        </ul>
                        <h4 class="font-semibold text-lg text-slate-700 mt-4">How Soil Health Affects Crop Nutrition</h4>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-slate-600">
                            <li>Soils rich in organic matter and microbial activity often produce crops with higher micronutrient concentrations.</li>
                            <li>Overuse of synthetic fertilizers and frequent tillage can disrupt soil life, reduce organic matter, and reduce long-term fertility.</li>
                            <li>Healthy soils help buffer stress (e.g. drought, pests), giving plants resilience.</li>
                            <li>Soils with good structure reduce erosion, nutrient leaching, and maintain stability.</li>
                        </ul>
                        <h4 class="font-semibold text-lg text-slate-700 mt-4">Managing Nutrients — Best Practices</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-300 mt-2">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900">Nutrient</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900">Source Strategies</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900">Tips & Caveats</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200 bg-white">
                                    <tr>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Nitrogen (N)</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Use organic sources: compost, green manures, biofertilizers. Legume rotations fix N.</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Apply in split doses. Avoid overapplication which causes leaching.</td>
                                    </tr>
                                    <tr>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Phosphorus (P) & Potassium (K)</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Use rock phosphate, compost, biochar, wood ash.</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Check soil test; excess P can cause environmental issues.</td>
                                    </tr>
                                    <tr>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Micronutrients (Zn, Fe, Mn, etc.)</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Use chelated formulations, foliar sprays, or soil amendments like zinc sulfate.</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Micronutrient deficiency often shows in leaves (chlorosis, stunting).</td>
                                    </tr>
                                    <tr>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Organic matter</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Regular addition of compost, mulch, cover crops.</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-600">Maintain 2–5% SOM (or more) depending on climate and cropping.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <h4 class="font-semibold text-lg text-slate-700 mt-4">Practices That Build Soil Health</h4>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-slate-600">
                            <li>No-till or reduced tillage: Protects soil structure and microbial habitat.</li>
                            <li>Cover crops / green manures: Provide continuous living roots, reduce erosion, fix N.</li>
                            <li>Crop rotation & diversity: Break pest/disease cycles, distribute nutrient demands.</li>
                            <li>Composting / organic amendments: Add humus, feed soil life.</li>
                            <li>Avoiding heavy chemical overuse: Preserve microbial diversity and soil enzyme functions.</li>
                            <li>Mulching: Retains moisture, moderates temperature, reduces erosion.</li>
                        </ul>
                    `,
                    youtubeLinks: [
                        'https://www.youtube.com/embed/videoseries?list=PL2hN8vwJse8tKzpma_8Z8XKRsFkCNENPh' 
                    ]
                }
            ]
        };

        let financialsChart = null;
        let expenseChart = null;
        
        // --- RENDER FUNCTIONS & API CALLS ---

        function updateWeatherWidget(data) {
            const container = document.getElementById('weather-card');
            container.innerHTML = `
                <h3 class="font-bold text-lg mb-4 opacity-90">Weather Updates</h3>
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm opacity-80">${data.location}</p>
                        <p class="text-6xl font-extrabold">${Math.round(data.current.temp)}°C</p>
                        <p class="font-semibold">Humidity: ${data.current.humidity}%</p>
                    </div>
                    <i class="${data.current.icon} text-8xl opacity-80"></i>
                </div>
                <div class="mt-6 grid grid-cols-5 gap-2 text-center">
                    ${data.forecast.map(day => `
                        <div class="text-center">
                            <p class="font-semibold">${day.day}</p>
                            <i class="${day.icon} text-4xl my-2"></i>
                            <p class="text-sm">${Math.round(day.high)}°/${Math.round(day.low)}°</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        async function fetchWeatherData() {
            const weatherCard = document.getElementById('weather-card');
            weatherCard.innerHTML = `<div class="text-center p-10"><div class="inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-white"></div><p class="text-white mt-2">Loading Weather...</p></div>`;

            // This is a simulated API call. In a real application, you would use fetch() to an actual weather API.
            // Using a timeout to simulate network latency.
            setTimeout(() => {
                const liveData = {
                    location: "Thrissur, Kerala",
                    current: MOCK_DATA.weather.current,
                    forecast: MOCK_DATA.weather.forecast
                };
                updateWeatherWidget(liveData);
            }, 1500);
        }


        function renderFarmConditions() {
            const container = document.getElementById('farm-conditions-container');
            container.innerHTML = MOCK_DATA.farmConditions.map(item => `
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-sm font-medium text-slate-600">${item.name}</p>
                        <p class="text-sm font-bold text-slate-800">${item.value}%</p>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div class="${item.color} h-2.5 rounded-full" style="width: ${item.value}%"></div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderYieldPrediction() {
            const container = document.getElementById('yield-prediction-card');
            const data = MOCK_DATA.yieldPrediction;
            container.innerHTML = `
                <h3 class="font-bold text-slate-800 text-lg mb-2">Yield Prediction</h3>
                <p class="text-sm text-slate-500 mb-4">${data.crop}</p>
                <p class="text-5xl font-extrabold text-emerald-600">${data.predicted}</p>
                <p class="text-sm text-slate-600 mt-2 font-semibold">Confidence: <span class="text-green-600">${data.confidence}</span></p>
            `;
        }

        function renderMarketPrices() {
            const container = document.getElementById('market-prices-list');
            const trendIcons = {
                up: '<i class="ph-bold ph-arrow-up text-green-500"></i>',
                down: '<i class="ph-bold ph-arrow-down text-red-500"></i>',
                stable: '<i class="ph-bold ph-minus text-slate-500"></i>'
            };
            container.innerHTML = MOCK_DATA.marketPrices.map(item => `
                <li class="flex justify-between items-center">
                    <span class="font-medium text-slate-700">${item.name}</span>
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold text-slate-800">${item.price}</span>
                        ${trendIcons[item.trend]}
                    </div>
                </li>
            `).join('');
        }

        function renderAiSuggestions() {
            const container = document.getElementById('ai-suggestions-list');
            container.innerHTML = MOCK_DATA.aiSuggestions.map(item => `
                <li class="flex items-start">
                    <i class="ph-fill ph-sparkle text-amber-500 text-xl mt-1"></i>
                    <p class="ml-3 text-slate-600">${item}</p>
                </li>
            `).join('');
        }

        function renderUpcomingTasks() {
            const container = document.getElementById('upcoming-tasks-list');
            container.innerHTML = MOCK_DATA.upcomingTasks.map(item => `
                <li class="flex items-center">
                    <div class="bg-emerald-100 text-emerald-700 font-bold text-sm rounded-md px-3 py-1">${item.time}</div>
                    <p class="ml-4 text-slate-700">${item.task}</p>
                </li>
            `).join('');
        }
        
        function renderFinancials() {
            const summaryContainer = document.getElementById('financials-summary-cards');
            const summary = MOCK_DATA.financials.summary;
            const formatCurrency = (value) => `₹${new Intl.NumberFormat('en-IN').format(value)}`;
            
            summaryContainer.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-lg card-hover">
                    <h4 class="text-slate-500 font-semibold">Total Income</h4>
                    <p class="text-4xl font-extrabold text-green-600 mt-2">${formatCurrency(summary.income)}</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg card-hover">
                    <h4 class="text-slate-500 font-semibold">Total Expenses</h4>
                    <p class="text-4xl font-extrabold text-red-600 mt-2">${formatCurrency(summary.expenses)}</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg card-hover">
                    <h4 class="text-slate-500 font-semibold">Net Profit</h4>
                    <p class="text-4xl font-extrabold text-emerald-700 mt-2">${formatCurrency(summary.profit)}</p>
                </div>
            `;
            
            const ctx = document.getElementById('financialsChart').getContext('2d');
            if (financialsChart) {
                financialsChart.destroy();
            }
            financialsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: MOCK_DATA.financials.chartData.labels,
                    datasets: [
                        {
                            label: 'Income',
                            data: MOCK_DATA.financials.chartData.income,
                            backgroundColor: 'rgba(5, 150, 105, 0.7)',
                            borderColor: 'rgba(5, 150, 105, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        },
                        {
                            label: 'Expenses',
                            data: MOCK_DATA.financials.chartData.expenses,
                            backgroundColor: 'rgba(220, 38, 38, 0.6)',
                            borderColor: 'rgba(220, 38, 38, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#e2e8f0' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
            renderExpenseChart();
            renderTransactionsList();
        }
        
        function renderExpenseChart() {
            const ctx = document.getElementById('expenseBreakdownChart').getContext('2d');
            const data = MOCK_DATA.financials.expenseBreakdown;
            if (expenseChart) {
                expenseChart.destroy();
            }
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Expense Breakdown',
                        data: data.data,
                        backgroundColor: [
                            '#10b981', // emerald-500
                            '#34d399', // emerald-400
                            '#6ee7b7', // emerald-300
                            '#a7f3d0', // emerald-200
                            '#d1fae5'  // emerald-100
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function renderTransactionsList() {
            const container = document.getElementById('transactions-list');
            const formatCurrency = (value) => `₹${new Intl.NumberFormat('en-IN').format(value)}`;
            container.innerHTML = MOCK_DATA.financials.transactions.map(item => `
                <li class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full ${item.type === 'income' ? 'bg-green-100' : 'bg-red-100'}">
                            <i class="ph-bold ${item.type === 'income' ? 'ph-arrow-up text-green-600' : 'ph-arrow-down text-red-600'}"></i>
                        </div>
                        <div class="ml-3">
                            <p class="font-semibold text-slate-800">${item.description}</p>
                            <p class="text-sm text-slate-500">${item.date}</p>
                        </div>
                    </div>
                    <p class="font-bold ${item.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${item.type === 'income' ? '+' : '-'}${formatCurrency(item.amount)}
                    </p>
                </li>
            `).join('');
        }
        
        function renderFutureAdvancements() {
            const container = document.getElementById('future-features-list');
            container.innerHTML = MOCK_DATA.futureAdvancements.map(item => `
                <div class="bg-white p-6 rounded-2xl shadow-lg card-hover">
                    <h3 class="text-2xl font-bold text-emerald-700">${item.title}</h3>
                    <p class="text-slate-600 mt-2">${item.description}</p>
                    <ul class="list-disc list-inside mt-4 space-y-1 text-slate-500">
                        ${item.details.map(detail => `<li>${detail}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }

        function renderMarketplace() {
            const container = document.getElementById('buyers-list');
            container.innerHTML = MOCK_DATA.buyers.map(buyer => `
                <div class="bg-white p-6 rounded-2xl shadow-lg card-hover">
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-slate-800 text-lg">${buyer.name}</h3>
                        <div class="flex items-center bg-amber-100 text-amber-800 text-sm font-bold px-2.5 py-1 rounded-full">
                            <i class="ph-fill ph-star text-amber-500"></i>
                            <span class="ml-1">${buyer.rating}</span>
                        </div>
                    </div>
                    <p class="text-sm text-slate-500">${buyer.location}</p>
                    <div class="mt-4">
                        <p class="text-sm font-semibold text-slate-700">Interested in:</p>
                        <div class="flex flex-wrap gap-2 mt-2">
                        ${buyer.interestedIn.map(crop => `<span class="bg-slate-200 text-slate-700 text-xs font-medium px-2.5 py-1 rounded-full">${crop}</span>`).join('')}
                        </div>
                    </div>
                    <button class="mt-6 w-full bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-700 transition-all">Contact Buyer</button>
                </div>
            `).join('');
        }
        
        function renderKnowledgeHub() {
             const container = document.getElementById('articles-list');
             container.innerHTML = MOCK_DATA.knowledgeArticles.map((article, index) => {
                 const imageUrl = article.image;
                 return `
                 <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-hover">
                     <div class="h-28 bg-cover bg-center" style="background-image: url('${imageUrl}');"></div>
                     <div class="p-6">
                         <p class="text-sm text-amber-700 font-semibold">${article.category}</p>
                         <h3 class="font-bold text-slate-800 text-lg mt-2">${article.title}</h3>
                         <div class="flex justify-between items-center mt-4 text-sm text-slate-500">
                             <span>${article.readTime} read</span>
                             <button class="learn-more-knowledge-btn font-semibold text-emerald-600 hover:underline" data-knowledge-id="${index}">Read More <i class="ph-bold ph-arrow-right"></i></button>
                         </div>
                     </div>
                 </div>
                 `;
             }).join('');
         }

        function renderSchemes() {
            const container = document.getElementById('schemes-list');
            container.innerHTML = MOCK_DATA.schemes.map((item, index) => `
                <div class="bg-white p-6 rounded-2xl shadow-lg card-hover flex flex-col justify-between">
                    <div>
                        <span class="bg-emerald-100 text-emerald-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${item.eligibility}</span>
                        <h3 class="font-bold text-slate-800 text-lg mt-3">${item.title}</h3>
                        <p class="text-slate-600 mt-2 text-sm">${item.description}</p>
                    </div>
                    <button class="learn-more-btn mt-4 text-emerald-600 font-semibold hover:underline text-left self-start" data-scheme-id="${index}">
                        Learn More <i class="ph-bold ph-arrow-right"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function renderForumPosts() {
            const container = document.getElementById('forum-posts');
            container.innerHTML = MOCK_DATA.forumPosts.map(item => `
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <p class="font-semibold text-slate-800">${item.user}</p>
                    <p class="text-slate-700 my-2">${item.post}</p>
                    <div class="flex items-center text-sm text-slate-500 space-x-4 mt-4">
                        <button class="hover:text-emerald-600 flex items-center gap-1"><i class="ph-bold ph-chat-circle-dots"></i> ${item.replies} Replies</button>
                        <button class="hover:text-emerald-600 flex items-center gap-1"><i class="ph-bold ph-heart"></i> ${item.likes} Likes</button>
                    </div>
                </div>
            `).join('');
        }

        // --- NAVIGATION ---
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        }

        hamburgerBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        function changePage(hash) {
            pages.forEach(page => page.classList.remove('active'));
            navLinks.forEach(link => link.classList.remove('active'));

            const activePage = document.querySelector(hash);
            const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);

            if (activePage) activePage.classList.add('active');
            if (activeLink) activeLink.classList.add('active');

            if (hash === '#financials') {
                renderFinancials();
            }
            // Close sidebar on mobile after navigation
            if (window.innerWidth < 768) {
                if(!sidebar.classList.contains('-translate-x-full')) {
                    toggleSidebar();
                }
            }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const hash = e.currentTarget.getAttribute('href');
                window.location.hash = hash;
            });
        });

        window.addEventListener('hashchange', () => {
            changePage(window.location.hash || '#dashboard');
        });
        
        // --- PEST DETECTION ---
        const dropZone = document.getElementById('drop-zone');
        const uploadSection = document.getElementById('upload-section');
        const previewSection = document.getElementById('preview-section');
        const fileInput = document.getElementById('crop-photo-input');
        const imagePreview = document.getElementById('image-preview');
        const analyzeButton = document.getElementById('analyze-button');
        const analysisReport = document.getElementById('analysis-report');
        const loadingSpinner = document.getElementById('loading-spinner');
        const reportContent = document.getElementById('report-content');
        const downloadReportBtn = document.getElementById('download-report-btn');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => e.preventDefault());
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect({ target: fileInput });
            }
        });

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.setAttribute('src', e.target.result);
                    uploadSection.classList.add('hidden');
                    previewSection.classList.remove('hidden');
                    analysisReport.classList.add('hidden');
                    reportContent.classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        analyzeButton.addEventListener('click', () => {
            previewSection.classList.add('hidden');
            analysisReport.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');

            setTimeout(() => {
                const reportData = MOCK_DATA.pestDetectionReport;
                document.getElementById('disease-name').textContent = reportData.diseaseName;
                document.getElementById('disease-confidence').textContent = reportData.confidence;
                document.getElementById('recommended-action').textContent = reportData.recommendedAction;
                document.getElementById('preventative-measures').textContent = reportData.preventativeMeasures;
                document.getElementById('organic-alternatives').textContent = reportData.organicAlternatives;
                
                loadingSpinner.classList.add('hidden');
                reportContent.classList.remove('hidden');
            }, 2500);
        });

        function downloadReport() {
            const reportData = MOCK_DATA.pestDetectionReport;
            let reportText = `
KRISHI SAKHI - PEST & DISEASE ANALYSIS REPORT
============================================

Disease Detected: ${reportData.diseaseName}
Confidence: ${reportData.confidence.split(': ')[1]}

Recommended Action:
${reportData.recommendedAction}

Preventative Measures:
${reportData.preventativeMeasures}

Organic Alternatives:
${reportData.organicAlternatives}
            `;
            
            const blob = new Blob([reportText.trim()], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'KrishiSakhi_PestReport.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        downloadReportBtn.addEventListener('click', downloadReport);


        // --- AI CHAT POPUP ---
        const chatPopup = document.getElementById('chat-popup');
        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        const expandChatBtn = document.getElementById('expand-chat-btn');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const aiChatInput = document.getElementById('ai-chat-input');
        const aiChatSendBtn = document.getElementById('search-icon');
        const aiChatHistory = document.getElementById('chat-popup-history');

        chatToggleBtn.addEventListener('click', () => {
            chatPopup.classList.toggle('active');
        });

        closeChatBtn.addEventListener('click', () => {
            chatPopup.classList.remove('active');
        });

        expandChatBtn.addEventListener('click', () => {
            chatPopup.classList.toggle('expanded');
        });

        function addAiChatMessage(text, sender) {
            const bubble = document.createElement('div');
            bubble.classList.add(sender === 'user' ? 'user-bubble' : 'ai-bubble');
            const p = document.createElement('p');
            p.textContent = text;
            bubble.appendChild(p);
            aiChatHistory.appendChild(bubble);
            aiChatHistory.scrollTop = aiChatHistory.scrollHeight;
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'ai-bubble typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            aiChatHistory.appendChild(indicator);
            aiChatHistory.scrollTop = aiChatHistory.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = aiChatHistory.querySelector('.typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // =======================================================
        // ========== START OF THE NEW CHATBOT API CODE ==========
        // =======================================================

        // IMPORTANT: Replace with your actual API key from Google AI Studio
        const API_KEY = 'YOUR_GEMINI_API_KEY';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`;
        
        /**
         * Sends a message to the Gemini API and gets a response.
         * @param {string} message The user's message.
         * @returns {Promise<string>} The AI's response.
         */
        async function getGeminiResponse(message) {
            // This is "prompt engineering". We give the AI a persona and context.
            const fullPrompt = `You are Krishi Sakhi, an expert AI assistant for Indian farmers, specializing in topics relevant to Kerala agriculture (like coconuts, rubber, paddy, spices). Your tone is helpful, encouraging, and easy to understand. Do not use complex jargon. Answer the following user query: "${message}"`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: fullPrompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error! Status: ${response.status}`);
                }

                const data = await response.json();
                // Safely access the response text
                const text = data.candidates[0]?.content?.parts[0]?.text;
                return text || "I'm sorry, I couldn't generate a response. Please try again.";

            } catch (error) {
                console.error("Error fetching from Gemini API:", error);
                return "Sorry, I'm having trouble connecting to my brain right now. Please check your API key or network connection and try again.";
            }
        }
        
        /**
         * Handles the entire process of sending a user message and displaying the AI response.
         */
        async function handleAiChatMessageSend() {
            const userMessage = aiChatInput.value.trim();
            if (userMessage) {
                addAiChatMessage(userMessage, 'user');
                aiChatInput.value = '';
                showTypingIndicator();
                
                // Call the new async function and wait for the response
                const aiResponse = await getGeminiResponse(userMessage);
                
                removeTypingIndicator();
                addAiChatMessage(aiResponse, 'ai');
            }
        }

        // =====================================================
        // ========== END OF THE NEW CHATBOT API CODE ==========
        // =====================================================

        aiChatSendBtn.addEventListener('click', handleAiChatMessageSend);
        aiChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevents form submission if it's inside a form
                handleAiChatMessageSend();
            }
        });
        
        // --- SCHEME DETAILS MODAL ---
        const schemeModal = document.getElementById('scheme-details-modal');
        const schemesListContainer = document.getElementById('schemes-list');

        function openSchemeModal(schemeData) {
            document.getElementById('modal-scheme-title').textContent = schemeData.title;
            document.getElementById('modal-scheme-description').textContent = schemeData.detailedDescription;
            
            const docList = document.getElementById('modal-scheme-documents');
            docList.innerHTML = schemeData.documents.map(doc => `<li>${doc}</li>`).join('');

            const applyLink = document.getElementById('modal-scheme-apply-link');
            applyLink.href = schemeData.applyLink;
            
            const youtubeContainer = document.getElementById('modal-youtube-container');
            const youtubeVideo = document.getElementById('modal-youtube-video');
            if (schemeData.youtubeLink) {
                youtubeVideo.src = schemeData.youtubeLink;
                youtubeContainer.classList.remove('hidden');
            } else {
                youtubeContainer.classList.add('hidden');
            }

            schemeModal.classList.remove('hidden');
        }

        function closeSchemeModal() {
            const youtubeVideo = document.getElementById('modal-youtube-video');
            schemeModal.classList.add('hidden');
            youtubeVideo.src = ""; // Stop video playback when modal is closed
        }

        // Event delegation for dynamically created buttons
        schemesListContainer.addEventListener('click', function(e) {
            const learnMoreButton = e.target.closest('.learn-more-btn');
            if (learnMoreButton) {
                const schemeId = learnMoreButton.getAttribute('data-scheme-id');
                const schemeData = MOCK_DATA.schemes[schemeId];
                if (schemeData) {
                    openSchemeModal(schemeData);
                }
            }
        });

        document.getElementById('modal-scheme-close').addEventListener('click', closeSchemeModal);

        // Close modal if user clicks outside of the content area
        schemeModal.addEventListener('click', function(e) {
            if (e.target === schemeModal) {
                closeSchemeModal();
            }
        });
        
        // --- KNOWLEDGE HUB DETAILS MODAL ---
        const knowledgeModal = document.getElementById('knowledge-details-modal');
        const articlesListContainer = document.getElementById('articles-list');

        function openKnowledgeModal(articleData) {
            document.getElementById('modal-knowledge-title').textContent = articleData.modalTitle;
            document.getElementById('modal-knowledge-content').innerHTML = articleData.detailedContent;
            
            const youtubeContainer = document.getElementById('modal-knowledge-youtube-container');
            youtubeContainer.innerHTML = '<h4 class="font-semibold text-lg text-slate-700 mb-2">Helpful Videos</h4>'; // Reset container
            
            if (articleData.youtubeLinks && articleData.youtubeLinks.length > 0) {
                articleData.youtubeLinks.forEach(link => {
                    const videoIdMatch = link.match(/(?:embed\/|v=|vi=|youtu\.be\/|videoseries\?list=)([^?&]+)/);
                    if(videoIdMatch && videoIdMatch[1]){
                        const videoId = videoIdMatch[1].startsWith('videoseries') ? videoIdMatch[1].split('=')[1] : videoIdMatch[1];
                        const facade = document.createElement('div');
                        facade.className = 'video-facade';
                        facade.style.backgroundImage = `url(https://img.youtube.com/vi/${videoId}/hqdefault.jpg)`;
                        facade.dataset.embedUrl = link;
                        youtubeContainer.appendChild(facade);
                    }
                });
                youtubeContainer.classList.remove('hidden');
            } else {
                youtubeContainer.classList.add('hidden');
            }

            knowledgeModal.classList.remove('hidden');
        }

        function closeKnowledgeModal() {
            knowledgeModal.classList.add('hidden');
             // Remove iframes to stop video playback
            const youtubeContainer = document.getElementById('modal-knowledge-youtube-container');
            youtubeContainer.innerHTML = '';
        }
        
        document.getElementById('modal-knowledge-youtube-container').addEventListener('click', function(e){
            const facade = e.target.closest('.video-facade');
            if(facade){
                const embedUrl = facade.dataset.embedUrl;
                const iframe = document.createElement('iframe');
                iframe.className = 'w-full aspect-video rounded-lg';
                iframe.src = embedUrl + '?autoplay=1';
                iframe.title = "YouTube video player";
                iframe.setAttribute('frameborder', '0');
                iframe.setAttribute('allow', 'accelerometer; autoplay=1; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                iframe.setAttribute('allowfullscreen', '');
                facade.replaceWith(iframe);
            }
        });


        articlesListContainer.addEventListener('click', function(e) {
            const learnMoreButton = e.target.closest('.learn-more-knowledge-btn');
            if (learnMoreButton) {
                const knowledgeId = learnMoreButton.getAttribute('data-knowledge-id');
                const articleData = MOCK_DATA.knowledgeArticles[knowledgeId];
                if (articleData) {
                    openKnowledgeModal(articleData);
                }
            }
        });

        document.getElementById('modal-knowledge-close').addEventListener('click', closeKnowledgeModal);

        knowledgeModal.addEventListener('click', function(e) {
            if (e.target === knowledgeModal) {
                closeKnowledgeModal();
            }
        });

        // --- TRANSACTION MODAL & Log Activity Modal & Quick Actions ---
        const logTransactionBtn = document.getElementById('log-transaction-btn');
        const transactionModal = document.getElementById('log-transaction-modal');
        const closeTransactionModalBtn = document.getElementById('close-transaction-modal');
        const transactionForm = document.getElementById('transaction-form');
        const categoryWrapper = document.getElementById('category-wrapper');
        const logModal = document.getElementById('log-activity-modal');
        const qaToggle = document.getElementById('quick-actions-toggle');
        const qaMenu = document.getElementById('quick-actions-menu');
        const qaItems = document.querySelectorAll('.quick-action-item');


        logTransactionBtn.addEventListener('click', () => transactionModal.classList.remove('hidden'));
        closeTransactionModalBtn.addEventListener('click', () => transactionModal.classList.add('hidden'));
        transactionModal.addEventListener('click', (e) => {
            if (e.target === transactionModal) {
                transactionModal.classList.add('hidden');
            }
        });
        
        document.getElementById('modal-cancel').addEventListener('click', () => logModal.classList.add('hidden'));
        document.getElementById('modal-save').addEventListener('click', () => {
            console.log('Activity logged:', document.getElementById('activity-log-input').value);
            document.getElementById('activity-log-input').value = '';
            logModal.classList.add('hidden');
        });

        transactionForm.addEventListener('change', (e) => {
            if (e.target.name === 'transaction-type') {
                categoryWrapper.style.display = e.target.value === 'expense' ? 'block' : 'none';
            }
        });

        transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newTransaction = {
                type: transactionForm['transaction-type'].value,
                description: document.getElementById('transaction-description').value,
                amount: parseFloat(document.getElementById('transaction-amount').value),
                date: new Date().toISOString().split('T')[0], // Today's date
                category: document.getElementById('transaction-category').value
            };
            
            console.log('New Transaction:', newTransaction);
            MOCK_DATA.financials.transactions.unshift(newTransaction);
            renderTransactionsList();

            transactionForm.reset();
            categoryWrapper.style.display = 'block';
            transactionModal.classList.add('hidden');
            showToast('Transaction logged successfully!');
        });

        qaToggle.addEventListener('click', () => {
            qaMenu.classList.toggle('hidden');
            const icon = qaToggle.querySelector('i');
            if (icon.classList.contains('ph-plus')) {
                icon.classList.remove('ph-plus');
                icon.classList.add('ph-x');
                qaToggle.classList.add('rotate-45');
            } else {
                icon.classList.remove('ph-x');
                icon.classList.add('ph-plus');
                qaToggle.classList.remove('rotate-45');
            }
        });

        function closeQuickActionsMenu() {
            qaMenu.classList.add('hidden');
            const icon = qaToggle.querySelector('i');
            icon.classList.remove('ph-x');
            icon.classList.add('ph-plus');
            qaToggle.classList.remove('rotate-45');
        }
        
        qaItems.forEach(item => {
            item.addEventListener('click', () => {
                const action = item.dataset.action;
                if (action === 'log') {
                    logModal.classList.remove('hidden');
                } else if (action === 'upload') {
                    window.location.hash = '#pest-detection';
                } else if (action === 'community') {
                    window.location.hash = '#community';
                }
                closeQuickActionsMenu();
            });
        });


        // --- LOGOUT ---
        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            
            showToast('Logging out...', 1500);

            setTimeout(() => {
                // Reset user to default
                currentUser = 'Farmer';
                updateDashboardGreeting();

                mainApp.classList.add('hidden');
                signupFlow.classList.remove('hidden');
                document.getElementById('fab-container').classList.add('hidden'); // Hide FABs
                showPhase(1);
                window.location.hash = '';
            }, 1500);
        });


        // --- INITIALIZE APP ---
        function init() {
            fetchWeatherData();
            renderFarmConditions();
            renderYieldPrediction();
            renderMarketPrices();
            renderAiSuggestions();
            renderUpcomingTasks();
            renderSchemes();
            renderForumPosts();
            renderMarketplace();
            renderKnowledgeHub();
            renderFutureAdvancements();
            changePage(window.location.hash || '#dashboard');
        }

        init();
    });
    </script>
</body>
</html>
